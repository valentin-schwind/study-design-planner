<!doctype html>
<html lang="en">
<head>
	<!-- Required meta tags -->
	<meta charset="iso-8859-1">
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
	<meta http-equiv="content-type" content="text/html; charset=iso-8859-1"/>
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta name="author" content="Valentin Schwind">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
 <!-- Bootstrap CSS -->
	<link rel="stylesheet" href="css/bootstrap.min.css">
	<link rel="stylesheet" href="css/bootstrap-icons.css">
	<link rel="stylesheet" href="css/style.css" />  
	<link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
	<meta property="og:site_name" content="Study Design and Statistical Test Planner">	
	<title>Study Design Generator</title>	
</head>
 <body class="transparent">
	<script src="js/countryList.js"></script> 
	<script src="js/jquery-3.6.0.min.js"></script>
	<script src="js/jquery-ui.js"></script>    
	<script src="js/bootstrap.bundle.min.js"></script>
	<script src="js/seedrandom.min.js"></script> 
	<script src="js/statistics.min.js"></script> 
	<script src="js/opencpu-0.5.js"></script>
    
	<div id="mainFrame" class="vertical-center">
		<div id="demographicsPage" class="whiteBox container rounded">
			
				<div id="input">
                    <div class="row">
                        <div class="col mt-4">
                            <a href="https://hci-studies.org"><img src="img/frankfurtlogo.png" class="float-end me-3" width="140px" alt="Interaction Lab Logo"></a>
                        </div>
                    </div>
                    <div class="row mt-3 align-items-center">
                        <div class="col">
                            <h3 id="demographicsTitle">Study Design and Statistical Test Planner</h3>
                        </div>
                    </div>
                    <hr /> 
					<form id="IVForm" class="form-horizontal"  action="javascript:generate(this);">
						<div class="row mt-1 align-items-center">
							<div class="col-4"><span id="selectIVText">Add your independent variables (IV)?</span><span class="text-danger">*</span><br /></div>
							<div class="col-2"><input class="form-control" name="nameIV" required></input></div>
							<div class="col-5"><select class="form-control" name="selectIVType" required></select></div>
							<div class="col-1"><button class="btn btn-primary btn-md float-right" type="submit"  id="addIV">Add</button></div>
						</div> 
						 <div class="row mt-1 align-items-center" id="withinIV" >
							<div class="col-4"></div>
							<div class="col-2 "><span class="align-items-center" >IV design</span></div>
							<div class="col-5"><select class="form-control" name="selectIVwithin" required></select></div>
						</div> 
						 <div class="row mt-1 align-items-center" id="levelsIV" >
							<div class="col-4"></div>
							<div class="col-2 "><span class="align-items-center" >with levels</span></div>
							<div class="col-5"><input class="form-control" name="enterLevelsIV" required></input></div>
						</div> 
						<div class="row mt-1 align-items-center">  
							<div class="col-4 mt-3 me-0"></div>   
							<div class="col-8 mt-1 ms-0 "><ul class="ms-0 " id="listIV"></ul></div>  
						</div> 
					</form>
					<form id="DVForm" class="form-horizontal" action="javascript:generate(this);">
						<div class="row mt-1 align-items-center" id="rowDV">
							<div class="col-4"><span id="selectDVText">Add your dependent variables (DV)?</span><span class="text-danger">*</span><br /></div>
							<div class="col-2"><input class="form-control" name="nameDV" ></input></div>
							<div class="col-5"><select class="form-control" name="selectDVType" ></select></div>
							<div class="col-1"><button class="btn btn-primary btn-md float-right"  id="addDV">Add</button></div> 
							<div class="col-4 me-0"></div>   
							<div class="col-8 mt-1 ms-0"><ul class="ms-0" id="listDV"></ul></div> 
						</div> 
					</form>
					
					<div class="row mt-1 " id="cellVARIANCE">  						
						<div class="col-4 mt-2 "><span>Highest standard deviation of your DVs (in %):</span><br /></div>
						<div class="col-8 mt-3 " ><form name="sampleForm">
							<input type="range" name="varianceInputName" style="width: 300px" id="varianceInputId" value="0.15" min="0" max="1" step="0.01" oninput="varianceOutputId.value = Math.floor((varianceInputId.value * 100),0) + ' %'"> 
							<output name="varianceOutputName" id="varianceOutputId">15 %</output>
							<!--<output name="varianceOutputLabelName" id="varianceOutputLabelId">medium</output>-->
						</form></div> 
					</div> 
					<div class="row mt-1 " id="cellEFFECTSIZE">  						
						<div class="col-4 mt-2 "><span>Smallest estimated DV mean difference (in %):</span><br /></div>
						<div class="col-8 mt-3 " ><form name="sampleForm">
							<input type="range" name="meanDeltaInputName" style="width: 300px" id="meanDeltaInputId" value="0.10" min="0.01" max="1" step="0.01" oninput="effectsizeOutputId.value = Math.floor((meanDeltaInputId.value * 100),0) + ' %'"> 
							<output name="effectsizeOutputName" id="effectsizeOutputId">10 %</output>
							<!--<output name="effectsizeOutputLabelName" id="effectsizeOutputLabelId">medium</output>-->
						</form></div> 
					</div>  
					<div class="row" id="cellMANOVA">  
						<div class="col-4"><span></span><br /></div>
						<div class="col-8 ms-0" ><input type="checkbox" class="form-check-input me-2" name="manovaCheckBox" id="manovaCheckBox"><label class="form-check-label" for="manovaCheckBox">Include test for effects <i>across</i> all DVs (MANOVA avoids Type-1 errors with too many DVs)</label></div>
					</div> 
					<div class="row" id="cellEQUIVALENCE">  						
						<div class="col-4"><span></span><br /></div>
						<div class="col-8 ms-0" ><input type="checkbox" class="form-check-input me-2" name="equivalenceCheckBox" id="equivalenceCheckBox"><label class="form-check-label" for="equivalenceCheckBox">test for equivalence (noninferiority)</label></div>
					</div> 
					<div class="row mt-1 " id="cellSAMPLES">  						
						<div class="col-4 mt-2 "><span>Subjects (N estimated by <a href='https://onlinelibrary.wiley.com/doi/10.1002/sim.4780110811'>Lehr's "Rule of 16"</a>:</span><br /></div>
						<div class="col-8 mt-3 " ><form name="sampleForm">
							<input type="range" name="samplesInputName" style="width: 300px" id="samplesInputId" value="24" min="0" max="200" oninput="samplesOutputId.value = samplesInputId.value">
							<output name="samplesOutputName" id="samplesOutputId">24</output>
						</form></div> 
					</div> 
					<hr /> 
					<div class="row mb-2 " id="rowED">  
						<div class="col-12 mt-2 me-0 mb-1 "><span><h5>Instructions for your experimental design:</h5></span></div>
                        <div class="col-12 mt-2 ms-0 mb-1 "><span id="design"></span></div>    
					</div>
					<div class="row mb-2 " id="rowST">  
						<div class="col-12 mt-2 me-0 mb-1 "><span><h5>Instructions for your statistical test(s):</h5></span></div>
                        <div class="col-12 mt-2 ms-0 mb-1 "><div id="results"></div></div>    
                    </div>
                    <div class="row mt-2 mb-2 itemRow" id="fieldsrequired">
                        <div class="col" >
                            <span class="text-danger">* fields required</span> <br />
                        </div>
                    </div> 
                    <div class="row mt-2 itemRow">
                        <div class="col" > 
							<a id="btnExample" class="btn btn-secondary btn-md float-left me-3 " >Example</a> 
                            <!--<button id="btnGenerate" class="btn btn-primary btn-md float-right" type="Submit">Generate</button> -->
                        </div>
                    </div> 
				<div class="row mt-2 mb-2 itemRow" id="githublink">
					<div class="col" > 
						<a href="https://github.com/interactionlab/informed-consent-generator/">Source Code on github</a>
					</div>
				</div>
				
			
		</div> 
	</div>
 
	<script>
		var debug = false;
		var IVs = 0;
		var DVs = 0;
		var manualEffectSizeUpdate = false;
		var manualSubjectUpdate = false;
		
		var studyDesign = {
			"IVs" : [],
			"DVs" : [],  
			"MANOVA" : false
		}	

		$(document).ready(function() {  
			$("#levelsIV").hide();
			$("#withinIV").hide();
			$("#rowDV").hide();
			$("#rowST").hide(); 
			$("#cellMANOVA").hide();
			$("#cellEQUIVALENCE").hide();
			$("#cellSAMPLES").hide();
			$("#rowED").hide();
			
			$("input[name='nameDV']").attr('placeholder', "Enter DV name...");
			$("input[name='enterLevelsIV']").attr('placeholder', "Enter levels (comma-separated)");
			$("input[name='nameIV']").attr('placeholder', "Enter IV name...");
			
			$("select[name='selectDVType']").append(new Option('Please select', ""));
            $("select[name='selectDVType']").append(new Option('Nominal (types, categories, gender, animals, ZIP codes,...)', "N")); 
            $("select[name='selectDVType']").append(new Option('Ordinal (marks, ranks, single Likert items, counts, ...)', "O")); 
            $("select[name='selectDVType']").append(new Option('Interval (arbitrary zero: distance, time, IQ, temperature in C, ...)', "I")); 
            $("select[name='selectDVType']").append(new Option('Ratio (fixed zero: age, volume, temperature in K, scores, bandwidth,...)', "R"));  
			
			$("select[name='selectIVType']").append(new Option('Please select', ""));
            $("select[name='selectIVType']").append(new Option('Nominal (types, categories, gender, animals, ZIP codes,...)', "N")); 
            $("select[name='selectIVType']").append(new Option('Ordinal (marks, ranks, single Likert items, counts, ...)', "O")); 
            $("select[name='selectIVType']").append(new Option('Interval (arbitrary zero: distance, time, IQ, temperature in C, ...)', "I")); 
            $("select[name='selectIVType']").append(new Option('Ratio (fixed zero: age, volume, temperature in K, scores, bandwidth,...)', "R")); 
			
			$("select[name='selectIVwithin']").append(new Option('Please select', ""));
			$("select[name='selectIVwithin']").append(new Option('within-subject (subjects are all assigned to this IV)', "within"));
			$("select[name='selectIVwithin']").append(new Option('between-subject (subjects are separated into groups)', "between"));
			
			$("input[name='manovaCheckBox']").prop( 'checked', false ); 			
			
			$("#btnExample").click(function() { 
				example();
			}); 		
			
			$("select[name='selectIVType']").change(function() { 
				if($("select[name='selectIVType']").val() == "N"){
					$("#levelsIV").show();
					$("#withinIV").show();
				} else {
					$("#levelsIV").hide();
					$("#withinIV").hide();
				}
			});	
			
			$("input[name='manovaCheckBox']").change(function() { 
				displaySTrow();
			});
			$("input[name='normalityCheckBox']").change(function() { 
				displaySTrow();
			}); 
			$("#samplesInputId").change(function() { 
				manualSubjectUpdate = true;
				displaySTrow();
				manualSubjectUpdate = false;
			});
			
			$("#varianceInputId").change(function() { 
				manualEffectSizeUpdate = true; 
				displaySTrow();
				manualEffectSizeUpdate = false;
			});
			$("#meanDeltaInputId").change(function() { 
				manualEffectSizeUpdate = true; 
				displaySTrow();
				manualEffectSizeUpdate = false;
			});
			
			$("#addIV").click(function() {
				$("input[name='nameIV']").prop("required", true); 
				$("select[name='selectIVType']").prop("required", true); 			
				if($("input[name='nameIV']").val() == "") return;
				if($("select[name='selectIVType']").val() == "") return;
				
				if($("select[name='selectIVType']").val() == "N") {
					if($('input[name="enterLevelsIV"]').val() == "") return; 
				} else { 
					$("select[name='selectIVwithin'] option:eq(1)").prop("selected", true);
				}
				
				var iconIVstr = "";
				var levelsIVstr = ""; 
				var levels = [ ];
				var IV = {
					"id": 0,
					"name": "",
					"type": "",
					"levels": [],
					"within": "" };
				IVs++;
				iconIVstr += getDataTypeIcon($("select[name='selectIVType']").val()); 
								
				if($("select[name='selectIVType']").val() == "N") {
					$("#withinIV").show();
					$("#levelsIV").show(); 
					
					levels = $('input[name="enterLevelsIV"]').val().split(',');
					
					if(levels){
						levelsIVstr = '<ul class="list-group list-group-horizontal">';
						$.each(levels, function(i){
							levelsIVstr += '<small><li class="list-group-item">' + levels[i] + '</li></small>'; 
							levels[i] = $.trim(levels[i]).replaceAll(" ","");
						});
						levelsIVstr += '</ul>';
						IV.levels = levels; 
					} 					
				} else {
					$("#levelsIV").hide();
					$("#withinIV").hide();
				}
				
				$("#listIV").append('<button type="button" id="buttonIV_' + IVs + '" class="btn btn-light me-1 mt-1"  style="vertical-align: top;">' + iconIVstr + $("input[name='nameIV']").val() + ' (' + $("select[name='selectIVwithin']").val() + ') <i class="bi ms-1 bi-x"" c></i>' + levelsIVstr + '</button>');
				
				$("#buttonIV_" + IVs).click(function(){  
					var removeItem;
					var myNumber = this.id.split('_')[1];
					$.each(studyDesign.IVs, function(i){
						if(studyDesign.IVs[i].id == myNumber) removeItem = i; 
					});
					studyDesign.IVs.splice(removeItem, 1); 
					$(this).remove();  
					displayDVrow(); 
					displaySTrow();
				});
								
				IV.id = IVs;
				IV.name = $("input[name='nameIV']").val();
				IV.type = $("select[name='selectIVType']").val();
				IV.within = $("select[name='selectIVwithin']").val();
				
				studyDesign.IVs.push(IV); 
				
				$("input[name='nameIV']").val("");
				$("select[name='selectIVType'] option:eq(0)").prop("selected", true);
				$("select[name='selectIVwithin'] option:eq(0)").prop("selected", true);
				$('input[name="enterLevelsIV"]').val("")
					
				$("#levelsIV").hide();
				$("#withinIV").hide();				

				displayDVrow();		
				displaySTrow();		
			});
			
			function displayDVrow(){  
				if(studyDesign.IVs.length > 0){
					$("input[name='nameIV']").prop("required", false); 
					$("select[name='selectIVType']").prop("required", false); 
					$("select[name='selectIVwithin']").prop("required", false); 
					$("input[name='enterLevelsIV']").prop("required", false); 
					$("input[name='nameDV']").prop("required", true); 
					$("select[name='selectDVType']").prop("required", true); 
					$("#rowDV").show();
				} else {
					$("input[name='nameIV']").prop("required", true); 
					$("select[name='selectIVType']").prop("required", true); 
					$("select[name='selectIVwithin']").prop("required", true); 
					$("input[name='enterLevelsIV']").prop("required", true); 
					$("input[name='nameDV']").prop("required", false); 
					$("select[name='selectDVType']").prop("required", false); 
					$("#rowDV").hide();
				}
			}
			
			$("#addDV").click(function() {
				$("input[name='nameDV']").prop("required", true); 
				$("select[name='selectDVType']").prop("required", true); 
				
				if($("input[name='nameDV']").val() == "") return;
				if($("select[name='selectDVType']").val() == "") return;
			
				var iconDVstr = "";
				var DV = {
					"id": 0,
					"name": "",
					"type": "" };
				DVs++;
				iconDVstr += getDataTypeIcon($("select[name='selectDVType']").val()); 
				
				$("#listDV").append('<button type="button" id="buttonDV_' + DVs + '" class="btn btn-light me-1 mt-1 ">' + iconDVstr + $("input[name='nameDV']").val() + '<i class="bi ms-1 bi-x "></i></button>');
				
				$("#buttonDV_" + DVs).click(function(){ 
					var removeItem;
					var myNumber = this.id.split('_')[1];
					$.each(studyDesign.DVs, function(i){
						if(studyDesign.DVs[i].id == myNumber) removeItem = i; 
					});
					studyDesign.DVs.splice(removeItem, 1); 
					$(this).remove();  
					displayDVrow(); 
					displaySTrow();
				});
				
				DV.id = DVs;
				DV.name = $("input[name='nameDV']").val();
				DV.type = $("select[name='selectDVType']").val(); 
				studyDesign.DVs.push(DV); 
				
				$("input[name='nameDV']").val("");
				$("select[name='selectDVType'] option:eq(0)").prop("selected", true); 
				displaySTrow();
			});
			
			 
			function displaySTrow(){ 
				if(studyDesign.DVs.length > 0){ 
					$("input[name='nameDV']").prop("required", false); 
					$("select[name='selectDVType']").prop("required", false); 						
				} else { 
					$("input[name='nameDV']").prop("required", true); 
					$("select[name='selectDVType']").prop("required", true); 
				}
				
				console.log(studyDesign);
				 
				if(studyDesign.DVs.length > 0 && studyDesign.IVs.length > 0){
					$("#rowST").show(); 
				} else {
					$("#rowST").hide(); 
				}
				
				if(studyDesign.DVs.length >= 1){
					$("#cellSAMPLES").show(); 
				} else {
					$("#cellSAMPLES").hide();
				}
				
				if(studyDesign.DVs.length > 1){
					$("#cellMANOVA").show();
				} else {
					$("#cellMANOVA").hide();
					$("input[name='manovaCheckBox']").prop( 'checked', false );
				}
				
				var anIVHasMoreThanTwoLevels = false;
				
				$.each(studyDesign.IVs, function(i){  
					if(studyDesign.IVs[i].levels.length > 2)  anIVHasMoreThanTwoLevels = true; 
				});
				
				if(studyDesign.IVs.length == 1 && studyDesign.DVs.length >= 1 && anIVHasMoreThanTwoLevels == false) $("#cellEQUIVALENCE").show();
				else $("#cellEQUIVALENCE").hide(); 
				
				var studyHasParametricData = false;
				$.each(studyDesign.DVs, function(i){  
					if(studyDesign.DVs[i].type == "I" || studyDesign.DVs[i].type == "R")  studyHasParametricData = true; 
				});
				 
				
				studyDesign.MANOVA = $("input[name='manovaCheckBox']").prop('checked');
				 
				if(studyDesign.DVs.length > 0 && studyDesign.IVs.length > 0) {
					var IVType = $("select[name='selectIVType']").val();
					var IVType = $("select[name='selectIVType']").val();
				} 
				
				showExperimentalDesign();
				showStatisticalTest();
			}
			  
			if(debug) $("#btnExample").click();
		}); 
		
			
		function getDataTypeIcon(val) {
			if(val == "N") return '<i class="bi bi-palette2 me-1"></i>';
			if(val == "O") return '<i class="bi bi-reception-4 me-1"></i>';
			if(val == "I") return '<i class="bi bi-rulers me-1"></i>';
			if(val == "R") return '<i class="bi bi-speedometer me-1"></i>'; 
			if(val == "M") return '<i class="bi bi-kanban me-1"></i>'; 
		}
		
		function getNamesFromArray(array, separator, name) {
			var str = ""; 
			$.each(array, function(i){
				if(name != null) str += array[i][name];
				else str += array[i]; str += separator; 
			});
			return str;
		}
		
		function getItemsInArray(array, variable, name) {
			var filteredArray = [];
			$.each(array, function(i){ if(array[i][variable] == name) filteredArray.push(array[i]); });
			return filteredArray;
		}
		
		function setSlider(slider, label, val, min, max, steps) {
			$(slider).prop("step", steps);
			$(slider).prop("min", min);
			$(slider).prop("max", max);
			if(!manualSubjectUpdate) $(slider).val(val);
			if(!manualSubjectUpdate) $(label).val(val);  
			return $(slider).val();
		}
		
		function getSampleSize(cv, pc, n, a) { 
			if (a == 0) a = 1;
			var Nb = (16 * (Math.pow(cv, 2) / (Math.pow(Math.log( 1 - pc), 2))));
			var Nw = Nb * ((1 - 0.5) / a)
			return Nw;
			// https://stats.stackexchange.com/questions/11131/sample-size-formula-for-an-f-test#:~:text=Lehr's%20formula%20for%20t%2Dtests,sided%20or%20two%20sided%20test.
		}
		
		function getEffectSizedz(delta, sd, corr) {   
			return (1 - getEffectSized(delta, sd)) / Math.sqrt(2 * ( 1 - corr));
			//return (Math.pow(pc, 2)/Math.pow(cv, 2)).toFixed(2)
			// https://stats.stackexchange.com/questions/11131/sample-size-formula-for-an-f-test#:~:text=Lehr's%20formula%20for%20t%2Dtests,sided%20or%20two%20sided%20test.
		}
		function getEffectSized(delta, sd) {   
			return delta / (Math.sqrt((Math.pow(sd, 2) + Math.pow(sd, 2))/2));
			//return (Math.pow(pc, 2)/Math.pow(cv, 2)).toFixed(2)
			// https://stats.stackexchange.com/questions/11131/sample-size-formula-for-an-f-test#:~:text=Lehr's%20formula%20for%20t%2Dtests,sided%20or%20two%20sided%20test.
		}
		function getEffectSizef(d, k) {   
			return Math.sqrt((Math.pow(d, 2) / (2 * k)));
			//return (Math.pow(pc, 2)/Math.pow(cv, 2)).toFixed(2)
			// https://stats.stackexchange.com/questions/11131/sample-size-formula-for-an-f-test#:~:text=Lehr's%20formula%20for%20t%2Dtests,sided%20or%20two%20sided%20test.
		}
		 
		function getPower(delta, variance, conditions, samples) {  
			var stats = new Statistics([],{},{}); 
			var n = samples / conditions;
			var val = ((delta) / (variance / Math.sqrt(n))) * -0.5;
			console.log(val);
			var single = stats.normalCumulativeValue(val);
			if(single >= 2.045) single = 2.045;
			if(single <= 0.005) single = 0.005;
			console.log(single);
			return 1-single;
		}
		
		function roundUp(x,y) {
			return Math.ceil(x/y)*y;
		}

		function showExperimentalDesign(){
			if(studyDesign.IVs.length >= 1 && studyDesign.DVs.length >= 1) $("#rowED").show();
			else $("#rowED").hide();
			
			var allWithinIVs = getItemsInArray(studyDesign.IVs, "within", "within"); 
			var withinIVs = getItemsInArray(getItemsInArray(studyDesign.IVs, "type", "N"), "within", "within"); 
			var betweenIVs = getItemsInArray(studyDesign.IVs, "within", "between"); 
			
			var allBetweenLevels = [];  
			$.each(betweenIVs, function(i){  
				$.each(betweenIVs[i].levels, function(j){   
					allBetweenLevels.push(betweenIVs[i].levels);
				});
			});  
			
			var withinConditions = []; 
				$.each(withinIVs, function(i){ 
					if(withinIVs[i].levels.length > 1)
						withinConditions.push(withinIVs[i].levels);
			});
			
			var betweenConditions = combineArrays(allBetweenLevels.filter(onlyUniqueValuesInArray));
			var withinConditions = combineArrays(withinConditions);
			var allConditions = betweenConditions.concat(withinConditions);   
			
			var sampleSize = Math.floor(getSampleSize($("#varianceInputId").val(), $("#meanDeltaInputId").val(), allConditions.length, withinConditions.length), 0);
			var effectSize = "";
			
			if(betweenConditions.length > 0) {
				//independent samples
				effectSizeD = "<i>d = </i>" + getEffectSized($("#meanDeltaInputId").val(), $("#varianceInputId").val()).toFixed(2) + ", "; 
			}
			if(withinConditions.length > 0) {
				//dependent samples 
				effectSize = "<i>dz = </i>" + getEffectSizedz($("#meanDeltaInputId").val(), $("#varianceInputId").val()).toFixed(2) + ", ";
			}
				
			var minParticipants = 0;
			var numParticipants = 0;
			
			if(withinConditions.length > 0 && withinConditions.length <= 3) minParticipants = permutations(withinConditions).length;
			if(withinConditions.length > 3 && withinConditions.length <= 12) minParticipants = withinConditions.length; 
			if(withinConditions.length > 3 && withinConditions.length <= 12) minParticipants = withinConditions.length;
			minParticipants = minParticipants * (betweenConditions.length > 0 ? betweenConditions.length : 1) * 2; 
			
			if(manualSubjectUpdate) numParticipants = $("#samplesInputId").val();
			else numParticipants = roundUp(sampleSize, minParticipants);
			
			if(numParticipants < allConditions.length) numParticipants = allConditions.length;
			
			var steps = allConditions.length;
			var samples = setSlider('#samplesInputId','#samplesOutputId', numParticipants, 0, 1200, steps);
			var power = Math.round(getPower($("#meanDeltaInputId").val(), $("#varianceInputId").val(), allConditions.length, samples) * 100);

			$("#samplesOutputId").html($("#samplesInputId").val() + " <span>("+ power + "% power, Effect Size " + effectSize +  ")</span>");
			
			console.log("numParticipants: " + numParticipants + " Effect Size: " + effectSize + " Sample Size: " + sampleSize + " samples: " +samples + " all levels: b" + (betweenConditions.length) + " w" + (withinConditions.length) + " " + (withinConditions.length + betweenConditions.length) +" all " + allConditions.length+" minParticipants " + minParticipants+" power " + power + " delta: " + $("#meanDeltaInputId").val() +  " variance: " + $("#varianceInputId").val());
			
			var resultStr = '<div class="accordion">';
 
			if(betweenIVs.length > 0) {  
				$.each(betweenConditions, function(i){ 
					betweenConditions[i] = betweenConditions[i].slice(0, -1);
				}); 
				
				resultStr += '<div class="accordion-item" id="accordionBetween"><button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseBetween" aria-controls="accordionBetween"><h6 class="accordion-header">' + getDataTypeIcon("M") + ' Assignment of conditions for your between-subject IVs (subjects are <i>split</i> into groups of your conditions)</h6></button><div id="collapseBetween" class="accordion-collapse collapse" aria-labelledby="panelsStayOpen-headingOne"><div class="accordion-body bg-light">Draw a random sample from a group or assign your subjects randomly and equally to each of the following ones: ' + arrayToDesignSequence(betweenConditions, "between", samples) + 'Please note that variance of measures from between-subject designs can be quite high. Please consider multiple task repetitions, equal balancing of groups, and as many samples as possible for these conditions (examples see above). In between-subject designs, the subjects are generally blind to the other conditions.</div></div></div>'; 
			}
			
			if(withinIVs.length > 0) {   
				$.each(withinConditions, function(i){ 
					withinConditions[i] = withinConditions[i].slice(0, -1);
				});
				
				resultStr += '<div class="accordion-item" id="accordionWithin"><button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseWithin" aria-controls="accordionWithin"><h6 class="accordion-header">' + getDataTypeIcon("M") + ' Sequence of conditions for your within-subject IVs (conditions to which <i>all</i> subjects are exposed to)</h6></button><div id="collapseWithin" class="accordion-collapse collapse" aria-labelledby="headingOne" data-bs-parent="#accordionWithin"><div class="accordion-body bg-light">';
				if(withinConditions.length <= 3) { 
					resultStr += "To avoid sequence effects order the " + withinConditions.length + " conditions of your within-subject IVs into <i>permutations</i>. Repeat the permutations with a multiple of " + permutations(withinConditions).length + ". For example with " + (permutations(withinConditions).length * 2) + ", " +  (permutations(withinConditions).length * 3) + ", " +  (permutations(withinConditions).length * 4) + "... subjects." + arrayToDesignSequence(withinConditions, "permutations") + ""; 
				}
				if(withinConditions.length > 3 && withinConditions.length <= 12) { 
					resultStr += "To avoid sequence effects order the " + withinConditions.length + " conditions of your within-subject IVs using a <i>" + withinConditions.length + "x" + withinConditions.length + " balanced Latin Square</i>. Repeat the Latin Square with a multiple of " + (withinConditions.length) + ". For example with " + (withinConditions.length * 2) + ", " +  (withinConditions.length * 3) + ", " +  (withinConditions.length * 4) + "... subjects." + arrayToDesignSequence(withinConditions, "latinSquare") + "";
				}
				if(withinConditions.length > 12) { 
					resultStr += "To avoid sequence effects put the " + withinConditions.length + " following conditions into a <i>pseudo-randomized order</i>. For example: " + arrayToDesignSequence(withinConditions, "shuffle", samples) ; 
				}
				resultStr += "</div></div></div>";
			} 
			
			resultStr+='</div>';
			$("#design").html(resultStr);
		}
		
		function arrayToDesignSequence(array, type, num) {
			var str = '<div class="table-responsive"><table class="table" ">';
			str += '<thead><tr>';
			for(var i = 0; i < array.length; i++) {
				if(i == 0) str += '<th scope="col"><strong>Subject</strong></th>';
				if(array.length > 10) str += '<th scope="col"><strong>Cond. ' + (i + 1) + ' </strong></th>';
				if(array.length <= 10) str += '<th scope="col"><strong>Condition ' + (i + 1) + ' </strong></th>';
			}
			str += '</tr></thead><tbody>';
			
			if(type == "latinSquare"){
				for(var n = 0; n < array.length; n++) {
					str += '<tr>';
					for(var i = 0; i < array.length; i++) {
						if(i == 0) str += '<th scope="row"><strong>' + (n + 1) + '</strong></th>';
						str += '<th><small>' + balancedLatinSquare(array, n)[i] + '</small></th>'; 
					}

					str += '</tr>';
				}
			}
			
			if(type == "permutations"){
				for(var n = 0; n < permutations(array).length; n++) {
					str += '<tr>';
					for(var i = 0; i < array.length; i++) {
						if(i == 0) str += '<th scope="row"><strong>' + (n + 1) + '</strong></th>'; 
						str += '<th><small>' + permutations(array)[n][i] + '</small></th>'; 
					}
					str += '</tr>';
				} 
			}
			
			if(type == "shuffle"){
				for(var n = 0; n < num; n++) {
					str += '<tr>';
					for(var i = 0; i < array.length; i++) {
						if(i == 0) str += '<th scope="row"><strong>' + (n + 1) + '</strong></th>'; 
						str += '<th><small>' + shuffle(array, n)[i] + '</small></th>'; 
					}
					str += '</tr>';
				}
			}
			
			if(type == "between"){ 
				str += '<tr>';
				for(var i = 0; i < array.length; i++) {
					if(i == 0) str += '<th scope="row"><strong>Name</strong></th>'; 
					str += '<th><small>' + array[i] + '</small></th>'; 
				}
				str += '</tr>'; 
				for(var n = 1; n < 4; n++) {
					str += '<tr>';
					for(var i = 0; i < array.length; i++) {
						if(i == 0) str += '<th scope="row"><strong>Samples (N = ' + num * n + ')</strong></th>'; 
						str += '<th><small>' + num * n / array.length + ' subjects </small></th>'; 
					} 
					str += '</tr>'; 
				}
				str += '<tr>'; 
				for(var i = 0; i < array.length; i++) {
					if(i == 0) str += '<th scope="row"><strong>...</strong></th>'; 
					str += '<th><small>...</small></th>'; 
				}
				str += '</tr>'; 
				str += '<tr>'; 
				for(var i = 0; i < array.length; i++) {
					if(i == 0) str += '<th scope="row"><strong>Samples in %</strong></th>'; 
					str += '<th><small>' + ( 100 / array.length ) + '%</small></th>'; 
				}
				str += '</tr>'; 
			}
			str += '</tbody></table></div>';
			return str;
		}
		
		function shuffle(array, seed) {
			Math.seedrandom(seed);
			var j, tmp;
			for (var i = array.length - 1; i > 0; i--) {
				j = Math.floor(Math.random() * (i + 1));
				tmp = array[i];
				array[i] = array[j];
				array[j] = tmp;
			}
			return array;
		}
		
		function permutations(xs, n) {
			var result = [];
			for (var i = 0; i < xs.length; i = i + 1) {
				var rest = permutations(xs.slice(0, i).concat(xs.slice(i + 1)));
				if(!rest.length) {
					result.push([xs[i]])
				} else {
					for(var j = 0; j < rest.length; j = j + 1) {
						result.push([xs[i]].concat(rest[j]))
					}
				}
			} 
			return result;
		}

		
		function balancedLatinSquare(array, subjectId) {
			var result = []; 
			for (var i = 0, j = 0, h = 0; i < array.length; ++i) {
				var val = 0;
				if (i < 2 || i % 2 != 0) {
					val = j++;
				} else {
					val = array.length - h - 1;
					++h;
				}

				var idx = (val + subjectId) % array.length;
				result.push(array[idx]);
			}

			if (array.length % 2 != 0 && subjectId % 2 != 0) {
				result = result.reverse();
			}

			return result;
		}

		
		function showStatisticalTest(){
			var resultStr = ""; 
			var withinIVs = getItemsInArray(studyDesign.IVs, "within", "within");
			var betweenIVs = getItemsInArray(studyDesign.IVs, "within", "between");
			var nominalIVs = getItemsInArray(studyDesign.IVs, "type", "N");   
			
			if(studyDesign.MANOVA) resultStr += '<div class="accordion-item" id="accordionMANOVA"><button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseMANOVA"  aria-controls="accordionMANOVA"><h6 class="accordion-header">' + getDataTypeIcon("M") + ' Inferential statistics requires a ' + number2words(studyDesign.IVs.length) + '-factorial ' + ((withinIVs.length >= 1 && betweenIVs.length >= 1) ? 'mixed-design ' : ' ') + 'MANOVA</h6></button><div id="collapseMANOVA" class="accordion-collapse collapse" aria-labelledby="panelsStayOpen-headingOne"><div class="accordion-body bg-light"><strong>Statistical test:</strong></br><code>model <- manova(cbind(' + getNamesFromArray(studyDesign.DVs, ", ", "name").slice(0, -2) + ') ~ ' + getNamesFromArray(studyDesign.IVs, " * ", "name").slice(0, -2) + ', data = data)<br />summary(model)<br />summary.aov(model)</code></br>for DVs that are significant (p &#8804; .05) you can perform univariate tests (see below)</div></div></div>';
			
			if(studyDesign.DVs.length > 0 && studyDesign.IVs.length > 0) {
				$.each(studyDesign.DVs, function(i){
					var testStr = "";   
					
					function generateAccordionHeader(i, name, statisticalTest, type) {
						return '<div class="accordion-item" id="accordion' + i +'"><button class="accordion-button collapsed " type="button" data-bs-toggle="collapse" data-bs-target="#collapse' + i +'" aria-controls="accordion' + i +'"><h6 class="accordion-header">' + getDataTypeIcon(type) + ' ' + studyDesign.DVs[i].name + ': ' + statisticalTest + '</h6></button><div id="collapse' + i +'" class="accordion-collapse collapse" aria-labelledby="panelsStayOpen-headingOne"><div class="accordion-body bg-light">';
					}
					
					function generateNormality(text, code, show) {
						if(show) 
							return '<strong><div class="mt-3">Normality test:</div></strong><div>' + text + '<br /><code>' + code + '</code></div>';
						else
							return "";
					}
					
					function generateRCode(title, text, code) {
						return '<strong><div class="mt-3">' + title + '</strong><br /></div><div>' + text + '<br /><code light-bg>' + code + '</code></div>';
					}
					
					function generateEffectSize(title, text, code) {
						return '<strong><div class="mt-3">' + title + '</strong><br /></div><div>' + text + '<br /><code light-bg>' + code + '</code></div>';
					}
					
					function generatePostHoc(title, text, code) {
						return '<strong><div class="mt-3">' + title + '</strong><br /></div><div>' + text + '<br /><code light-bg>' + code + '</code></div>';
					}
					
					function generateAccordionFooter() {
						return '</div></div></div></div>';
					}
					
					function tabPills(id, question, title1, title2, tab1, tab2) {
						return '<div class="mt-3">' + question + '</div><ul class="nav nav-pills mb-3 mt-3" white" id="pills-tab-' + id + '" role="tablist"><li class="nav-item" role="presentation"><button class="nav-link active btn-light me-1" id="pills-' + title1 + '-tab-' + id + '" data-bs-toggle="pill" data-bs-target="#pills-' + title1 + '-' + id + '" type="button" role="tab" aria-controls="pills-' + title1 + '-' + id + '" aria-selected="true">' + title1 + '</button>   </li> <li class="nav-item" role="presentation"><button class="nav-link" id="pills-' + title2 + '-tab-' + id + '" data-bs-toggle="pill" data-bs-target="#pills-' + title2 + '-' + id + '" type="button" role="tab" aria-controls="pills-' + title2 + '-' + id + '" aria-selected="false">' + title2 + '</button>   </li></ul> <div class="tab-content" id="pills-tabContent"><div class="tab-pane fade show active" id="pills-' + title1 + '-' + id + '" role="tabpanel" aria-labelledby="pills-' + title1 + '-tab-' + id + '">' + tab1 + '</div>   <div class="tab-pane fade" id="pills-' + title2 + '-' + id + '" role="tabpanel" aria-labelledby="pills-' + title2 + '-tab-' + id + '">' + tab2 + '</div> </div>';
					}
					
					if(withinIVs.length >= 1 && betweenIVs.length >= 1) {  
						var parametricTestStr = generateRCode('Your statistical test for parametric data', 'The test provided by the <code>rstatix</code>-package automatically applies Greenhouse-Geisser correction to your within-subjects IVs violating the sphericity assumption (when Mauchly\'s test p-value is significant, p &#8804; 0.05).','library(rstatix)<br />aov <- anova_test(data = data, dv = ' + studyDesign.DVs[i].name + ', wid = SubjectID,  between = c(' + getNamesFromArray(betweenIVs, ", ", "name").slice(0, -2) + '), within = c(' + getNamesFromArray(withinIVs, ", ", "name").slice(0, -2) + ')</br>get_anova_table(aov)');
						parametricTestStr += generatePostHoc('The post hoc test for parametric data', 'Post hoc tests of interaction effects can computed with the <code>testInteraction()</code> procedure of the <code>phia</code> package in R. Such results are difficult to interpret. With main effects only you can perform pairwise comparisons using t-tests, e.g.:','library(rstatix)<br />t_test(data = data, ' + studyDesign.DVs[i].name + ' ~ ' + withinIVs[0].name + ')');
						parametricTestStr += generateEffectSize('Evaluate your effect size','To determine your main and interaction effect size <i>partial eta-squared</i> of a multi-factorial ANOVA you can use the following interpretation: 0.01 - 0.01 (small effect), 0.01 - 0.06 (moderate effect) and 0.06 - 0.14 (large effect).','library(rstatix)<br />aov <- anova_test(data = data, dv = ' + studyDesign.DVs[i].name + ', wid = SubjectID,  between = c(' + getNamesFromArray(betweenIVs, ", ", "name").slice(0, -2) + '), within = c(' + getNamesFromArray(withinIVs, ", ", "name").slice(0, -2) + ')</br>get_anova_table(aov)');
						
						var nonparametricTestStr = generateRCode('Your statistical test for non-parametric data', 'The test by the <code>ARTool</code>-package performs a non-parametric ' + number2words(studyDesign.IVs.length) + '-factorial mixed-design ART-ANOVA.','library(ARTool)<br />art <- art(data = data, ' + studyDesign.DVs[i].name + ' ~ ' + getNamesFromArray(studyDesign.IVs, " * ", "name").slice(0, -2) + ' + (1|SubjectID) )</br>anova(art)');	
						nonparametricTestStr += generatePostHoc('The post hoc test for non-parametric data', 'Post hoc tests of interaction effects can computed with the <code>testInteraction()</code> procedure of the <code>phia</code> package in R. Such results are difficult to interpret. With main effects only you can perform pairwise comparisons using Wilcoxon signed-rank tests, e.g.:','library(rstatix)<br />wilcox_test(data = data, ' + studyDesign.DVs[i].name + ' ~ ' + withinIVs[0].name + ', paired=TRUE)');	
						nonparametricTestStr += generateEffectSize('Evaluate your effect size','Save your non-parametric ART-ANOVA model above. Add a new column with (SS/SS+SStotal) deriving your main and interaction effect size <i>partial eta-squared</i> and use the following interpretation: 0.01 - 0.01 (small effect), 0.01 - 0.06 (moderate effect) and 0.06 - 0.14 (large effect).','anova.art <- anova(art)<br />anova.art$eta.sq.part = anova.art$`Sum Sq`/(anova.art$`Sum Sq` + anova.art$`Sum Sq.res`)<br />anova.art');
						
						if(studyDesign.DVs[i].type == "R" || studyDesign.DVs[i].type == "I") {
							// mixed design ANOVA 
							resultStr += generateAccordionHeader(i, studyDesign.DVs[i].name, "a " + number2words(studyDesign.IVs.length) + "-factorial mixed-design ANOVA", studyDesign.DVs[i].type);
							resultStr += generateNormality('Your settings suggest that you can potentially apply parametric tests. Before doing so you must check your conditions for normal distribution using the test by Shapiro-Wilk.','library(rstatix)<br />library(tidyverse)<br />data %>% group_by(' + getNamesFromArray(nominalIVs, ", ", "name").slice(0, -2) + ') %>% shapiro_test(' + studyDesign.DVs[i].name + ')', true); 
							resultStr += (($("#samplesInputId").val() > 50) ? '<div class="mt-3">Your sample size is greater than 50. If any of the Shapiro-Wilk\'s tests is significant, your can also test your data using a normal QQ plot which draws a correlation between the given data and its normal distribution. If all points for each cell fall approximately along the reference line, you can assume normality of the data without Shapiro-Wilk\'s test. The plot can created using the <code>ggpubr</code> package.<br /> <code>library(ggpubr)<br />ggqqplot(data, "' + studyDesign.DVs[i].name + '", ggtheme = theme_bw()) + facet_grid(' + getNamesFromArray(withinIVs, " ~ ", "name").slice(0, -3).replace(/[\~\%]/g, function(match, offset, all) { return match === "~" ? (all.indexOf("~") === offset ? '~' : '+') : ''; })  + ')</code></div>' : '')							
							resultStr += tabPills(i, "Do the tests indicate that your data is normal distributed (all p&#8805; 0.05 for all conditions)?", "yes","no", parametricTestStr, nonparametricTestStr);	 	 					
						} else { // mixed-design ART ANOVA 
							resultStr += generateAccordionHeader(i, studyDesign.DVs[i].name, "a " + number2words(studyDesign.IVs.length) + "-factorial mixed-design aligned-rank transform (ART) ANOVA", studyDesign.DVs[i].type);
							resultStr += nonparametricTestStr;
						} 
					}
					
					if(withinIVs.length >= 1 && betweenIVs.length == 0) {  
						if(withinIVs.length > 1 || withinIVs[0].levels.length > 2) {
							var parametricTestStr = generateRCode('Your statistical test for parametric data', 'The test provided by the <code>rstatix</code>-package automatically applies Greenhouse-Geisser correction to your within-subjects IVs violating the sphericity assumption (when Mauchly\'s test p-value is significant, p &#8804; 0.05).','library(rstatix)<br />aov <- anova_test(data = data, dv = ' + studyDesign.DVs[i].name + ', wid = SubjectID, within = c(' + getNamesFromArray(withinIVs, ", ", "name").slice(0, -2) + ')</br>get_anova_table(aov)');
							parametricTestStr += generatePostHoc('Your post hoc test for parametric data', 'Post hoc tests of interaction effects can computed with the <code>testInteraction()</code> procedure of the <code>phia</code> package in R. Such results are difficult to interpret. With main effects only you can perform pairwise comparisons using t-tests, e.g.:','library(rstatix)<br />t_test(data = data, ' + studyDesign.DVs[i].name + ' ~ ' + withinIVs[0].name + ')');
							parametricTestStr += generateEffectSize('Evaluate your effect size','To determine your main and interaction effect size <i>partial eta-squared</i> of a multi-factorial ANOVA you can use the following interpretation: 0.01 - 0.01 (small effect), 0.01 - 0.06 (moderate effect) and 0.06 - 0.14 (large effect).','library(rstatix)<br />aov <- anova_test(data = data, dv = ' + studyDesign.DVs[i].name + ', wid = SubjectID, within = c(' + getNamesFromArray(withinIVs, ", ", "name").slice(0, -2) + '), effect.size = "pes")</br>get_anova_table(aov)');
							
							var nonparametricTestStr = "";
							if(withinIVs.length > 1){
								var nonparametricTestStr = generateRCode('Your statistical test for non-parametric data', 'The test by the <code>ARTool</code>-package performs a non-parametric ' + number2words(studyDesign.IVs.length) + '-factorial mixed-design ART-ANOVA.','library(ARTool)<br />art <- art(data = data, ' + studyDesign.DVs[i].name + ' ~ ' + getNamesFromArray(studyDesign.IVs, " * ", "name").slice(0, -2) + ' + (1|SubjectID) )</br>anova(art)');	
								nonparametricTestStr += generatePostHoc('The post hoc test for non-parametric data', 'Post hoc tests of interaction effects can computed with the <code>testInteraction()</code> procedure of the <code>phia</code> package in R. Such results are difficult to interpret. With main effects only you can perform pairwise comparisons using Wilcoxon signed-rank tests, e.g.:','wilcox_test(data = data, ' + studyDesign.DVs[i].name + ' ~ ' + withinIVs[0].name + ')');	
								nonparametricTestStr += generateEffectSize('Evaluate your effect size','Save your non-parametric ART-ANOVA model above. Add a new column with (SS/SS+SStotal) deriving your main and interaction effect size <i>partial eta-squared</i> and use the following interpretation: 0.01 - 0.01 (small effect), 0.01 - 0.06 (moderate effect) and 0.06 - 0.14 (large effect).','anova.art <- anova(art)<br />anova.art$eta.sq.part = anova.art$`Sum Sq`/(anova.art$`Sum Sq` + anova.art$`Sum Sq.res`)<br />anova.art');
							} else {
								nonparametricTestStr += generateRCode('Your statistical test for non-parametric data', 'The test performs a non-parametric Friedman rank sum test.','library(rstatix)<br />friedman_test(data = data, ' + studyDesign.DVs[i].name + ' ~ ' + withinIVs[0].name + ' | SubjectID)'); 
								nonparametricTestStr += generatePostHoc('Your post hoc test for parametric data', 'With significant main effect(s), you can perform pairwise comparisons using Wilcoxon signed-rank tests, e.g.:','library(rstatix)<br />wilcox_test(data = data, ' + studyDesign.DVs[i].name + ' ~ ' + withinIVs[0].name + ', paired=TRUE)');  
								nonparametricTestStr += generateEffectSize('Evaluate your effect size','To determine your main effect size <i>Kendall W</i> of a one-factorial non-parametric RM-ANOVA you can use the Cohen\'s interpretation guidelines of 0.1 - 0.3 (small effect), 0.3 - 0.5 (moderate effect) and >= 0.5 (large effect).','library(rstatix)<br />friedman_effsize(data = data, ' + studyDesign.DVs[i].name + ' ~ ' + withinIVs[0].name + ' | SubjectID)');  
							}
							
							// RM ANOVA
							if(studyDesign.DVs[i].type == "R" || studyDesign.DVs[i].type == "I") {
								resultStr += generateAccordionHeader(i, studyDesign.DVs[i].name, "a " + number2words(studyDesign.IVs.length) + "-factorial repeated-measures (RM) ANOVA", studyDesign.DVs[i].type);
								resultStr += generateNormality('Your settings suggest that you can potentially apply parametric tests. Before doing so you must check your conditions for normal distribution using the test by Shapiro-Wilk.','library(rstatix)<br />library(tidyverse)<br />data %>% group_by(' + getNamesFromArray(nominalIVs, ", ", "name").slice(0, -2) + ') %>% shapiro_test(' + studyDesign.DVs[i].name + ')', true); 
								resultStr += (($("#samplesInputId").val() > 50) ? '<div class="mt-3">Your sample size is greater than 50. If any of the Shapiro-Wilk\'s tests is significant, your can also test your data using a normal QQ plot which draws a correlation between the given data and its normal distribution. If all points for each cell fall approximately along the reference line, you can assume normality of the data without Shapiro-Wilk\'s test. The plot can created using the <code>ggpubr</code> package.<br /> <code>library(ggpubr)<br />ggqqplot(data, "' + studyDesign.DVs[i].name + '", ggtheme = theme_bw()) + facet_grid(' + getNamesFromArray(withinIVs, " ~ ", "name").slice(0, -3).replace(/[\~\%]/g, function(match, offset, all) { return match === "~" ? (all.indexOf("~") === offset ? '~' : '+') : ''; })  + ')</code></div>' : '')							
								resultStr += tabPills(i, "Do the tests indicate that your data is normal distributed (all p&#8805; 0.05 for all conditions)?", "yes","no", parametricTestStr, nonparametricTestStr); 
							} else { // FRIEDMAN ANOVA
								if(studyDesign.IVs.length == 1){
									resultStr += generateAccordionHeader(i, studyDesign.DVs[i].name, "a Friedman rank sum test (or non-parametric one-way repeated measures ANOVA)", studyDesign.DVs[i].type);
									resultStr += nonparametricTestStr;
								} else {
									 // ART ANOVA
									resultStr += generateAccordionHeader(i, studyDesign.DVs[i].name, "a " + number2words(studyDesign.IVs.length) + "-factorial aligned-rank transform (ART) repeated-measure (RM) ANOVA", studyDesign.DVs[i].type);
									resultStr += nonparametricTestStr;  
								}
							}
						}  else { // paired t-test 
						
							var parametricTestStr = generateRCode('Your statistical test for parametric data', 'Classic t-test between paired samples.','library(rstatix)<br />t_test(data = data, ' + studyDesign.DVs[i].name + ' ~ ' + studyDesign.IVs[0].name + ', paired = TRUE)');
							parametricTestStr += generateEffectSize('Evaluate your effect size','Effect sizes for paired (dependent) t-tests <i>d</i> poposed by Cohen, are: 0.1 - 0.2 (small effect), 0.2 - 0.5 (moderate effect) and 0.5 - 0.8 (large effect) (Cohen 1998, Navarro (2015)). This means that if two groups\' means don\'t differ by 0.2 standard deviations or more, the difference is trivial, even if it is statistically significant.','library(rstatix)<br />cohens_d(data = data, ' + studyDesign.DVs[i].name + ' ~ ' + studyDesign.IVs[0].name + ', paired = TRUE)');
							
							var nonparametricTestStr = generateRCode('Your statistical test for non-parametric data', 'A non-parametric test between two paired (dependent) samples.','library(rstatix)<br />wilcox_test(data = data, ' + studyDesign.DVs[i].name + ' ~ ' + studyDesign.IVs[0].name + ', paired = TRUE)');  
							nonparametricTestStr += generateEffectSize('Evaluate your effect size','The interpretation of the effect size of a non-parametric test between two paired (dependent) samples <i>r</i> is commonly: 0.1 - 0.3 (small effect), 0.3 - 0.5 (moderate effect) and > 0.5 (large effect).','library(rstatix)<br />wilcox_effsize(data = data, ' + studyDesign.DVs[i].name + ' ~ ' + studyDesign.IVs[0].name + ', paired = TRUE)');
							
							if(studyDesign.DVs[i].type == "R" || studyDesign.DVs[i].type == "I") { 
								resultStr += generateAccordionHeader(i, studyDesign.DVs[i].name, "an paired (dependent) t-test", studyDesign.DVs[i].type);
								resultStr += generateNormality('Your settings suggest that you can potentially apply parametric tests. Before doing so you must check your conditions for normal distribution using the test by Shapiro-Wilk.','library(rstatix)<br />library(tidyverse)<br />data %>% group_by(' + getNamesFromArray(nominalIVs, ", ", "name").slice(0, -2) + ') %>% shapiro_test(' + studyDesign.DVs[i].name + ')', true);  
								resultStr += tabPills(i, "Do the tests indicate that your data is normal distributed (all p&#8805; 0.05)?", "yes","no", parametricTestStr, nonparametricTestStr);  
							} else {
								resultStr += generateAccordionHeader(i, studyDesign.DVs[i].name, "a paired Wilcoxon signed-rank test", studyDesign.DVs[i].type);
								resultStr += nonparametricTestStr
							}								
						}
					}
					
					if(withinIVs.length == 0 && betweenIVs.length >= 1) { 
						if(betweenIVs.length > 1 || betweenIVs[0].levels.length > 2) {
							var parametricTestStr = generateRCode('Your statistical test for parametric data', 'The test provided by the <code>rstatix</code>-package performs a multi-factorial ANOVA of independent samples','library(rstatix)<br />aov <- anova_test(data = data, dv = ' + studyDesign.DVs[i].name + ',  between = c(' + getNamesFromArray(betweenIVs, ", ", "name").slice(0, -2) + '))</br>get_anova_table(aov)'); 
							parametricTestStr += generatePostHoc('Your post hoc test for parametric data', 'Post hoc tests of interaction effects can computed with the <code>testInteraction()</code> procedure of the <code>phia</code> package in R. Such results are difficult to interpret. With main effects only you can perform pairwise comparisons using t-tests, e.g.:','library(rstatix)<br />t_test(data = data, ' + studyDesign.DVs[i].name + ' ~ ' + betweenIVs[0].name + ')');
							parametricTestStr += generateEffectSize('Evaluate your effect size','To determine your main and interaction effect size <i>partial eta-squared</i> of a multi-factorial independent samples ANOVA you can use the following interpretation: 0.01 - 0.01 (small effect), 0.01 - 0.06 (moderate effect) and 0.06 - 0.14 (large effect).','library(rstatix)<br />aov <- anova_test(data = data, dv = ' + studyDesign.DVs[i].name + ', between = c(' + getNamesFromArray(betweenIVs, ", ", "name").slice(0, -2) + '), effect.size = "pes")</br>get_anova_table(aov)');
							
							var nonparametricTestStr = generateRCode('Your statistical test for non-parametric data', 'The test by the <code>ARTool</code>-package performs a non-parametric ' + number2words(studyDesign.IVs.length) + '-factorial mixed-design ART-ANOVA.','library(ARTool)<br />art <- art(data = data, ' + studyDesign.DVs[i].name + ' ~ ' + getNamesFromArray(studyDesign.IVs, " * ", "name").slice(0, -2) + '  )</br>anova(art)');
							nonparametricTestStr += generatePostHoc('The post hoc test for non-parametric data', 'Post hoc tests of interaction effects can computed with the <code>testInteraction()</code> procedure of the <code>phia</code> package in R. Such results are difficult to interpret. With main effects only you can perform pairwise comparisons using Wilcoxon signed-rank tests, e.g.:','library(rstatix)<br />wilcox_test(data = data, ' + studyDesign.DVs[i].name + ' ~ ' + betweenIVs[0].name + ')');	
							nonparametricTestStr += generateEffectSize('Evaluate your effect size','Save your non-parametric ART-ANOVA model above. Add a new column with (SS/SS+SStotal) deriving your main and interaction effect size <i>partial eta-squared</i> and use the following interpretation: 0.01 - 0.01 (small effect), 0.01 - 0.06 (moderate effect) and 0.06 - 0.14 (large effect).','anova.art <- anova(art)<br />anova.art$eta.sq.part = anova.art$`Sum Sq`/(anova.art$`Sum Sq` + anova.art$`Sum Sq.res`)<br />anova.art');


							 
							if(studyDesign.DVs[i].type == "R" || studyDesign.DVs[i].type == "I") { 
								// independent ANOVA 
								resultStr += generateAccordionHeader(i, studyDesign.DVs[i].name, "a " + number2words(studyDesign.IVs.length) + "-factorial independent samples ANOVA", studyDesign.DVs[i].type);
								resultStr += generateNormality('Your settings suggest that you can potentially apply parametric tests. Before doing so you must check your conditions for normal distribution using the test by Shapiro-Wilk.','library(rstatix)<br />library(tidyverse)<br />data %>% group_by(' + getNamesFromArray(nominalIVs, ", ", "name").slice(0, -2) + ') %>% shapiro_test(' + studyDesign.DVs[i].name + ')', true); 
								resultStr += (($("#samplesInputId").val() > 50) ? '<div class="mt-3">Your sample size is greater than 50. If any of the Shapiro-Wilk\'s tests is significant, your can also test your data using a normal QQ plot which draws a correlation between the given data and its normal distribution. If all points for each cell fall approximately along the reference line, you can assume normality of the data without Shapiro-Wilk\'s test. The plot can created using the <code>ggpubr</code> package.<br /> <code>library(ggpubr)<br />ggqqplot(data, "' + studyDesign.DVs[i].name + '", ggtheme = theme_bw()) + facet_grid(' + getNamesFromArray(withinIVs, " ~ ", "name").slice(0, -3).replace(/[\~\%]/g, function(match, offset, all) { return match === "~" ? (all.indexOf("~") === offset ? '~' : '+') : ''; })  + ')</code></div>' : '')							
								resultStr += tabPills(i, "Do the tests indicate that your data is normal distributed (all p&#8805; 0.05 for all conditions)?", "yes","no", parametricTestStr, nonparametricTestStr); 
							}  else {  
								// independent non-parametric (ART) ANOVA
								resultStr += generateAccordionHeader(i, studyDesign.DVs[i].name, "a " + number2words(studyDesign.IVs.length) + "-factorial aligned-rank transform (ART) ANOVA of independent samples", studyDesign.DVs[i].type);
								resultStr += nonparametricTestStr; 
							}
						}  else { // independent t-test 
							var parametricTestStr = generateRCode('Your statistical test for parametric data', 'A classical t-test between two independent samples.','library(rstatix)<br />t_test(data = data, ' + studyDesign.DVs[i].name + ' ~ ' + studyDesign.IVs[0].name + ', paired = FALSE)');	
							parametricTestStr += generateEffectSize('Evaluate your effect size','Effect sizes for independent t-tests <i>d</i> poposed by Cohen, are: 0.1 - 0.2 (small effect), 0.2 - 0.5 (moderate effect) and 0.5 - 0.8 (large effect) (Cohen 1998, Navarro (2015)). This means that if two groups\' means don\'t differ by 0.2 standard deviations or more, the difference is trivial, even if it is statistically significant.','library(rstatix)<br />cohens_d(data = data, ' + studyDesign.DVs[i].name + ' ~ ' + studyDesign.IVs[0].name + ', paired = FALSE)');
							
							var nonparametricTestStr = generateRCode('Your statistical test for non-parametric data', 'A non-parametric test between two independent samples.','library(rstatix)<br />wilcox_test(data = data, ' + studyDesign.DVs[i].name + ' ~ ' + studyDesign.IVs[0].name + ', paired = FALSE)');  
							nonparametricTestStr += generateEffectSize('Evaluate your effect size','The interpretation of the effect size of a non-parametric test between two independent samples <i>r</i> is commonly: 0.1 - 0.3 (small effect), 0.3 - 0.5 (moderate effect) and > 0.5 (large effect).','library(rstatix)<br />wilcox_effsize(data = data, ' + studyDesign.DVs[i].name + ' ~ ' + studyDesign.IVs[0].name + ', paired = FALSE)');
							
							if(studyDesign.DVs[i].type == "R" || studyDesign.DVs[i].type == "I") {  
								resultStr += generateAccordionHeader(i, studyDesign.DVs[i].name, "an independent t-test", studyDesign.DVs[i].type);
								resultStr += generateNormality('Your settings suggest that you can potentially apply parametric tests. Before doing so you must check your conditions for normal distribution using the test by Shapiro-Wilk.','library(rstatix)<br />library(tidyverse)<br />data %>% group_by(' + getNamesFromArray(nominalIVs, ", ", "name").slice(0, -2) + ') %>% shapiro_test(' + studyDesign.DVs[i].name + ')', true); 
								resultStr += (($("#samplesInputId").val() > 50) ? '<div class="mt-3">Your sample size is greater than 50. If any of the Shapiro-Wilk\'s tests is significant, your can also test your data using a normal QQ plot which draws a correlation between the given data and its normal distribution. If all points for each cell fall approximately along the reference line, you can assume normality of the data without Shapiro-Wilk\'s test. The plot can created using the <code>ggpubr</code> package.<br /> <code>library(ggpubr)<br />ggqqplot(data, "' + studyDesign.DVs[i].name + '", ggtheme = theme_bw()) + facet_grid(' + getNamesFromArray(withinIVs, " ~ ", "name").slice(0, -3).replace(/[\~\%]/g, function(match, offset, all) { return match === "~" ? (all.indexOf("~") === offset ? '~' : '+') : ''; })  + ')</code></div>' : '') 
								resultStr += tabPills(i, "Do the tests indicate that your data is normal distributed (all p&#8805; 0.05 for all conditions)?", "yes","no", parametricTestStr, nonparametricTestStr);  
							} else {  // independent non-parametric test
								resultStr += generateAccordionHeader(i, studyDesign.DVs[i].name, "a Mann-Whitney U test (a.k.a. two-sample Wilcoxon test)", studyDesign.DVs[i].type);
								resultStr += nonparametricTestStr;
								
							}
						}
					}
					resultStr += generateAccordionFooter();  
				});
			}
			$("#results").html("<div class='accordion'>" + resultStr + "</div>");
		}
		
		function example(){  
			$("input[name='nameIV']").val("Prototype");
			$("select[name='selectIVType'] option:eq(1)").prop("selected", true);
			$("select[name='selectIVwithin'] option:eq(1)").prop("selected", true);
			$("input[name='enterLevelsIV']").val("Prototype A, Prototype B, Prototype C");
			$("#addIV").click();
			$("input[name='nameIV']").val("Scenario");
			$("select[name='selectIVType'] option:eq(1)").prop("selected", true);
			$("select[name='selectIVwithin'] option:eq(1)").prop("selected", true);
			$("input[name='enterLevelsIV']").val("Scenario A, Scenario B, Scenario C, Scenario D");
			$("#addIV").click();
			$("input[name='nameIV']").val("Volume");
			$("select[name='selectIVType'] option:eq(4)").prop("selected", true);
			$("select[name='selectIVwithin'] option:eq(1)").prop("selected", true);
			//$("input[name='enterLevelsIV']").val("Scenario A, Scenario B");
			$("#addIV").click();
			$("input[name='nameIV']").val("Gender");
			$("select[name='selectIVType'] option:eq(1)").prop("selected", true);
			$("select[name='selectIVwithin'] option:eq(2)").prop("selected", true);
			$("input[name='enterLevelsIV']").val("men, women");
			$("#addIV").click();  
			$("input[name='nameIV']").val("World");
			$("select[name='selectIVType'] option:eq(1)").prop("selected", true);
			$("select[name='selectIVwithin'] option:eq(2)").prop("selected", true);
			$("input[name='enterLevelsIV']").val("Virtual Reality, Real World");
			$("#addIV").click();  
			
			$("input[name='nameDV']").val("Presence");
			$("select[name='selectDVType'] option:eq(4)").prop("selected", true);
			$("#addDV").click();
			$("input[name='nameDV']").val("Throughput");
			$("select[name='selectDVType'] option:eq(4)").prop("selected", true);
			$("#addDV").click();
			$("input[name='nameDV']").val("Clicks");
			$("select[name='selectDVType'] option:eq(2)").prop("selected", true);
			$("#addDV").click();
			$("input[name='nameDV']").val("Distance");
			$("select[name='selectDVType'] option:eq(3)").prop("selected", true);
			$("#addDV").click();
		};
		
		function generate() {
		}
	 	
		
		var num = "zero one two three four five six seven eight nine ten eleven twelve thirteen fourteen fifteen sixteen seventeen eighteen nineteen".split(" ");
		var tens = "twenty thirty forty fifty sixty seventy eighty ninety".split(" ");

		function number2words(n){
			if (n < 20) return num[n];
			var digit = n%10;
			if (n < 100) return tens[~~(n/10)-2] + (digit? "-" + num[digit]: "");
			if (n < 1000) return num[~~(n/100)] +" hundred" + (n%100 == 0? "": " and " + number2words(n%100));
			return number2words(~~(n/1000)) + " thousand" + (n%1000 != 0? " " + number2words(n%1000): "");
		}
		
		function combineArrays( array_of_arrays ){ 
			if(!array_of_arrays) return [];
			if(!Array.isArray(array_of_arrays)) return [];
			if( array_of_arrays.length == 0 ) return [];

			for(let i = 0; i < array_of_arrays.length; i++ ){
				if(!Array.isArray(array_of_arrays[i]) || array_of_arrays[i].length == 0 ) return []; 
			}
  
			let odometer = new Array( array_of_arrays.length );
			odometer.fill(0); 

			let output = [];
			let newCombination = formCombination( odometer, array_of_arrays );
			output.push( newCombination );

			while ( odometer_increment( odometer, array_of_arrays ) ){
				newCombination = formCombination( odometer, array_of_arrays );
				output.push( newCombination );
			}

			return output;
		}
		
		function onlyUniqueValuesInArray(value, index, self) {
			return self.indexOf(value) === index;
		}

 
		function formCombination( odometer, array_of_arrays ){ 
			return odometer.reduce(
			  function(accumulator, odometer_value, odometer_index){
				return "" + accumulator + array_of_arrays[odometer_index][odometer_value] + "-";
			  },
			  ""
			);
		}

		function odometer_increment( odometer, array_of_arrays ){
			for( let i_odometer_digit = odometer.length-1; i_odometer_digit >=0; i_odometer_digit-- ){ 
				let maxee = array_of_arrays[i_odometer_digit].length - 1;         
				if( odometer[i_odometer_digit] + 1 <= maxee ){
					odometer[i_odometer_digit]++;
					return true;
				} else{
					if( i_odometer_digit - 1 < 0 ){	return false;}
					else{
						odometer[i_odometer_digit]=0;
						continue;
					}
				}
			}
		}
		
		function qnorm(p) {
    // ALGORITHM AS 111, APPL.STATIST., VOL.26, 118-121, 1977.
    // Computes z=invNorm(p)
    p=parseFloat(p);
    split=0.42;
    a0=  2.50662823884;
    a1=-18.61500062529;
    a2= 41.39119773534;
    a3=-25.44106049637;
    b1= -8.47351093090;
    b2= 23.08336743743;
    b3=-21.06224101826;
    b4=  3.13082909833;
    c0= -2.78718931138;
    c1= -2.29796479134;
    c2=  4.85014127135;
    c3=  2.32121276858;
    d1=  3.54388924762;
    d2=  1.63706781897;
    q=p-0.5;
    if(Math.abs(q)<=split) {
      r=q*q;
      ppnd=q*(((a3*r+a2)*r+a1)*r+a0)/((((b4*r+b3)*r+b2)*r+b1)*r+1);
    }
    else {
      r=p;
      if(q>0) r=1-p;
      if(r>0) {
        r=Math.sqrt(-Math.log(r));
        ppnd=(((c3*r+c2)*r+c1)*r+c0)/((d2*r+d1)*r+1);
        if(q<0) ppnd=-ppnd;
      }
      else {
        ppnd=0;
      }
    }
    return(ppnd);
  }
	</script>
 </body>
</html>